<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Pranic Map - Final Layout Fix</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* BASE STYLES: Use full viewport height and disable body scroll on desktop */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            color: #1f2937;
            display: flex;
            justify-content: center;
            align-items: center; 
            min-height: 100vh;
            /* CRITICAL: Prevents scrollbar on the main body on larger screens */
            height: 100vh; 
            overflow: hidden; 
            padding: 10px;
        }

        /* --- Main Wrapper: Fixed Height, NO SCROLLING on desktop --- */
        .map-wrapper {
            width: 100%;
            max-width: 1400px;
            /* CRITICAL FIX: Ensure the wrapper consumes the height but doesn't overflow the body */
            height: 95vh; 
            background-color: #ffffff;
            border-radius: 16px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            display: flex;
            flex-direction: column;
            overflow: hidden; /* Hide internal overflow for clean edges */
        }

        /* --- Map Canvas Container --- */
        .map-container {
            position: relative;
            flex-grow: 1;
            background-color: #ffffff;
            overflow: hidden;
        }

        /* --- Shared Element Styles --- */
        .chakra, .nadi-line, .vayu-region {
            position: absolute;
            transition: all 0.5s ease-in-out, box-shadow 0.3s ease-in-out;
            border-radius: 9999px; /* Rounded corners for all elements */
            cursor: pointer;
        }

        /* --- CHAKRAS (Dots) --- */
        .chakra {
            width: 20px;
            height: 20px;
            z-index: 10;
            background-color: #d1d5db; /* Inactive Chakra color */
            transform: translate(-50%, -50%); /* Center based on position */
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.1);
        }
        
        /* CHAKRA ACTIVE STATE (Glow) */
        .chakra.active-flow {
            /* The base color changes dynamically via JS */
            box-shadow: 0 0 10px 5px var(--chakra-color), 0 0 20px 10px var(--chakra-color);
            transform: translate(-50%, -50%) scale(1.5);
            animation: pulse 1.5s infinite alternate;
        }

        /* --- NADIS (Lines) --- */
        .nadi-line {
            width: 10px;
            /* CRITICAL FIX: Inactive Nadis are now pure black for maximum visibility */
            background-color: #000000; 
            z-index: 5;
            top: 5%; /* Start below Sahasrara */
            height: 90%; /* Span most of the body length */
            transform: translateX(-50%); /* Center on the 'left' property */
        }

        /* Specific Nadi positioning */
        #sushumna-nadi { left: 50%; }
        #ida-nadi { left: calc(50% - 20px); }
        #pingala-nadi { left: calc(50% + 20px); }

        /* NADI ACTIVE STATE (Glow & Color) */
        .nadi-line.active-flow {
            background-color: var(--nadi-color); /* Color changes dynamically via JS */
            box-shadow: 0 0 10px 2px var(--nadi-color);
            /* Added subtle border for contrast against white background */
            border: 1px solid rgba(0, 0, 0, 0.3); 
        }

        /* --- VAYU REGIONS (Transparent zones) --- */
        .vayu-region {
            z-index: 1;
            opacity: 0.1; /* Very subtle appearance */
            border: 1px dashed transparent;
        }

        /* VAYU ACTIVE STATE (Colored border) */
        .vayu-region.active-flow {
            border: 2px dashed var(--vayu-color);
            background-color: var(--vayu-color);
            opacity: 0.2;
        }

        /* --- Info Box --- */
        #info-box {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: none;
            z-index: 50;
        }
        
        /* --- Crown Dots (Bindu) --- */
        .bindu-dot {
            width: 5px;
            height: 5px;
            background-color: #ffffff;
            border: 1px solid #1f2937;
            position: absolute;
            top: -10px; /* Position relative to Sahasrara */
            border-radius: 50%;
            transform: translate(-50%, -50%);
            z-index: 10;
        }

        @keyframes pulse {
            0% { opacity: 0.8; }
            100% { opacity: 1; }
        }

        /* Responsive adjustments for mobile/smaller screens */
        @media (max-width: 1024px) {
            body {
                height: auto;
                overflow-y: auto;
                padding: 5px;
            }
            .map-wrapper {
                flex-direction: column;
                height: auto;
                min-height: 100vh;
                margin: 10px 0;
            }
            .map-container {
                height: 50vh; /* Give map decent size on top */
            }
            /* Adjust positioning of lines for smaller screens if necessary, though percentages help */
        }
    </style>
</head>
<body>

    <div class="map-wrapper shadow-xl">
        <header class="p-4 bg-gray-50 border-b border-gray-200">
            <h1 class="text-2xl font-bold text-center text-indigo-700">Interactive Pranic Flow Map (Nadis, Chakras, Vayus)</h1>
        </header>

        <div class="flex flex-col lg:flex-row flex-grow overflow-hidden">
            
            <!-- Left Panel: The Map Container -->
            <div class="map-container flex-1 border-r border-gray-200 p-4">
                <div class="relative w-full h-full">

                    <!-- Body Outline Placeholder (Visual aid for positioning) -->
                    <div class="absolute inset-0 flex justify-center items-center pointer-events-none">
                        <div class="w-2/5 h-full max-h-full border-x border-gray-300 rounded-t-full relative">
                            <!-- Simple body shape proxy -->
                        </div>
                    </div>

                    <!-- --- Vayu Regions (Behind Nadis) --- -->
                    <div id="vayu-vyana" data-info="vayu-vyana" class="vayu-region bg-pink-300 w-full h-full"></div>
                    <div id="vayu-samana" data-info="vayu-samana" class="vayu-region bg-green-300 w-1/2 h-1/3 top-1/3 left-1/4"></div>
                    <div id="vayu-udana" data-info="vayu-udana" class="vayu-region bg-purple-300 w-1/4 h-1/4 top-0 left-3/8"></div>
                    <div id="vayu-prana" data-info="vayu-prana" class="vayu-region bg-blue-300 w-1/4 h-1/4 top-1/4 left-3/8"></div>
                    <div id="vayu-apana" data-info="vayu-apana" class="vayu-region bg-red-300 w-1/4 h-1/4 bottom-0 left-3/8"></div>

                    <!-- --- Nadis (Lines) --- -->
                    <div id="sushumna-nadi" data-info="nadi-sushumna" class="nadi-line"></div>
                    <div id="ida-nadi" data-info="nadi-ida" class="nadi-line"></div>
                    <div id="pingala-nadi" data-info="nadi-pingala" class="nadi-line"></div>
                    
                    <!-- --- Chakras (Dots) and Bindu --- -->
                    <div id="chakra-sahasrara" data-info="chakra-sahasrara" class="chakra top-[5%] left-[50%]" style="background-color: #a78bfa;">
                        <!-- Bindu Dots -->
                        <div class="bindu-dot left-[50%]"></div>
                        <div class="bindu-dot left-[calc(50%-10px)]"></div>
                        <div class="bindu-dot left-[calc(50%+10px)]"></div>
                    </div>
                    <div id="chakra-ajna" data-info="chakra-ajna" class="chakra top-[10%] left-[50%]" style="background-color: #3b82f6;"></div>
                    <div id="chakra-vishuddha" data-info="chakra-vishuddha" class="chakra top-[25%] left-[50%]" style="background-color: #06b6d4;"></div>
                    <div id="chakra-anahata" data-info="chakra-anahata" class="chakra top-[45%] left-[50%]" style="background-color: #10b981;"></div>
                    <div id="chakra-manipura" data-info="chakra-manipura" class="chakra top-[60%] left-[50%]" style="background-color: #f59e0b;"></div>
                    <div id="chakra-svadhisthana" data-info="chakra-svadhisthana" class="chakra top-[75%] left-[50%]" style="background-color: #f97316;"></div>
                    <div id="chakra-muladhara" data-info="chakra-muladhara" class="chakra top-[90%] left-[50%]" style="background-color: #ef4444;"></div>
                    
                    <!-- Info Box (Hidden by default) -->
                    <div id="info-box" class="bg-gray-900 text-white p-4 rounded-lg shadow-2xl max-w-sm">
                        <h3 id="info-title" class="text-lg font-bold mb-2"></h3>
                        <p id="info-content" class="text-sm"></p>
                    </div>

                </div>
            </div>

            <!-- Right Panel: Flow Guide and Explanation -->
            <div class="flow-guide-container w-full lg:w-96 flex flex-col p-6 bg-white border-l border-gray-200 h-full">
                
                <h2 class="text-xl font-semibold text-indigo-700 mb-4 border-b pb-2">Prana Ascension Flow Guide</h2>

                <!-- Control Buttons -->
                <div class="flex space-x-2 mb-4">
                    <button id="next-step-button" class="flex-1 bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-150">Start Flow</button>
                    <button id="reset-button" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg shadow-md transition duration-150" style="display: none;">Reset</button>
                </div>

                <!-- Flow Steps List (Scrollable) -->
                <div id="flow-steps-list" class="space-y-2 mb-4 overflow-y-auto max-h-40 lg:max-h-56 p-2 rounded-lg bg-gray-50 border">
                    <!-- Steps will be generated here -->
                </div>

                <!-- Explanation Box (Fixed Height, Scrollable Content) -->
                <div class="flex-grow flex flex-col mt-4 border-t pt-4 min-h-0">
                    <h3 id="explanation-title" class="text-lg font-bold mb-2 text-indigo-800">Welcome</h3>
                    <div id="flow-explanation-box" class="flex-grow text-gray-700 text-sm leading-relaxed overflow-y-auto pr-2">
                        <p>Click **"Start Flow"** to begin the meditation and learn how to activate the central energy channel and ascend through the seven Chakras and five Vayus.</p>
                        <p class="mt-2">Hover over any **Nadi** (line), **Chakra** (dot), or **Vayu** (area) on the map for anatomical and energetic details.</p>
                    </div>
                </div>

                <!-- Activation Toggle Button -->
                <button id="activate-all-button" class="mt-4 bg-orange-500 hover:bg-orange-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-150">Activate All (Simulate Samadhi)</button>
            </div>

        </div>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const mapContainer = document.querySelector('.map-container');
            const nextStepButton = document.getElementById('next-step-button');
            const resetButton = document.getElementById('reset-button');
            const activateAllButton = document.getElementById('activate-all-button');
            const flowStepsList = document.getElementById('flow-steps-list');
            const explanationTitleEl = document.getElementById('explanation-title');
            const explanationTextEl = document.getElementById('flow-explanation-box');
            
            let currentFlowStep = 0; // 0 = initial, 1-7 = chakra steps, 8 = complete/samadhi
            let isAllActive = false;

            // --- Configuration Data ---
            const chakraColors = {
                'muladhara': '#ef4444', 'svadhisthana': '#f97316', 'manipura': '#f59e0b', 
                'anahata': '#10b981', 'vishuddha': '#06b6d4', 'ajna': '#3b82f6', 
                'sahasrara': '#a78bfa'
            };
            const nadiColors = { 'sushumna': '#facc15', 'ida': '#3b82f6', 'pingala': '#f59e0b' };
            const vayuColors = { 
                'prana': '#3b82f6', 'samana': '#10b981', 'apana': '#ef4444', 
                'udana': '#a78bfa', 'vyana': '#f59e0b' 
            };
            
            // Full Flow: 1-7 are Chakra activations, 8 is Samadhi
            const flowExplanations = {
                0: { title: "Welcome to the Prana Flow Map", text: "Click **'Start Flow'** to begin the step-by-step ascension meditation practice." },
                1: { title: "Step 1: Grounding - Muladhara Chakra",
                     text: `<strong>Subtle-Physical Link:</strong> Located at the base of the spine (coccyx and perineum), linked to the **Pelvic Floor** and **Adrenal Glands** (stress response). Governs the nervous system's 'fight or flight' response.<br><br>
                            <strong>Activation Practice:</strong> Focus attention at the perineum. Practice **Mula Bandha** (root lock) on the exhale. Visualize a solid **red square**. Chant the **LAM** mantra. This activates **Apana Vayu** (downward moving energy) for elimination and grounding.`
                },
                2: { title: "Step 2: Creativity - Svadhisthana Chakra",
                     text: `<strong>Subtle-Physical Link:</strong> Located in the lower abdomen, linked to the **Reproductive Organs** and **Kidneys**. Governs the lymphatic system and the flow of bodily fluids.<br><br>
                            <strong>Activation Practice:</strong> Focus at the sacrum and lower back. Visualize a swirling **orange crescent moon**. Practice **Ashwini Mudra** (contraction of anal sphincter). Chant the **VAM** mantra. This flow stabilizes personal emotion and sexual energy.`
                },
                3: { title: "Step 3: Power - Manipura Chakra",
                     text: `<strong>Subtle-Physical Link:</strong> Located at the solar plexus, linked to the **Pancreas** and **Digestive Fire**. Governs metabolism and the assimilation of energy and nutrients.<br><br>
                            <strong>Activation Practice:</strong> Focus deeply behind the navel center. Practice **Uddiyana Bandha** (abdominal lock). Visualize a brilliant **yellow triangle**. Chant the **RAM** mantra. This activates **Samana Vayu** (balancing, radiating energy) for digestion and core confidence.`
                },
                4: { title: "Step 4: Compassion - Anahata Chakra",
                     text: `<strong>Subtle-Physical Link:</strong> Located in the center of the chest, linked to the **Heart** and **Thymus Gland** (immune system). Governs the circulatory and respiratory systems.<br><br>
                            <strong>Activation Practice:</strong> Focus in the center of the sternum. Practice **Raja Mudra** (hands cupped over the heart). Visualize a vibrant **green six-pointed star**. Chant the **YAM** mantra. This activates **Prana Vayu** (forward moving, receiving energy) for life force and unconditional love.`
                },
                5: { title: "Step 5: Expression - Vishuddha Chakra",
                     text: `<strong>Subtle-Physical Link:</strong> Located at the throat, linked to the **Thyroid Gland**. Governs metabolism and growth. Associated with communication, truth, and purifying toxins.<br><br>
                            <strong>Activation Practice:</strong> Focus at the throat pit. Practice **Jalandhara Bandha** (throat lock). Visualize a radiant **sky-blue circle**. Chant the **HAM** mantra. This energy supports self-expression and listening.`
                },
                6: { title: "Step 6: Intuition - Ajna Chakra",
                     text: `<strong>Subtle-Physical Link:</strong> Located between the eyebrows, linked to the **Pituitary Gland** (the "master gland"). Governs hormonal balance and sensory perception.<br><br>
                            <strong>Activation Practice:</strong> Focus intently on the space between the eyebrows (the third eye). Visualize a deep **indigo-blue lotus**. Chant the **OM** mantra. This is the seat of higher thought and intuitive insight.`
                },
                7: { title: "Step 7: Consciousness - Sahasrara Chakra",
                     text: `<strong>Subtle-Physical Link:</strong> Located at the crown of the head, linked to the **Pineal Gland**. Governs spiritual awareness, cognitive function, and connection to Universal energy.<br><br>
                            <strong>Activation Practice:</strong> Focus at the crown, just above the physical head. Visualize a thousand-petaled **violet and white lotus**. Meditate on the **Silence** (the un-struck sound). This activates **Udana Vayu** (upward moving energy) guiding consciousness toward transcendence.`
                },
                8: { title: "Samadhi - Complete Flow & Transcendence",
                     text: `<strong>All Nadis, Chakras, and Vayus are fully integrated.</strong><br><br>The energy has ascended the **Sushumna Nadi** and unified all centers. The ultimate state of Samadhi (absorption) represents the complete balance of Ida (lunar) and Pingala (solar) currents, allowing the vital force to flow unobstructed. Continue to sit in silent **meditation** with a balanced breath and full absorption in the light.`
                }
            };
            
            // --- Utility Functions ---

            // Show details for a hovered element
            function showInfoBox(element) {
                const type = element.getAttribute('data-info').split('-')[0];
                const key = element.getAttribute('data-info').split('-')[1];
                let title = '';
                let content = '';

                // Simplified hover data for Nadis, Chakras, Vayus
                const infoData = {
                    'nadi-sushumna': { title: 'Sushumna Nadi (Central)', content: 'The central channel of Prana, running along the spine. Activation leads to spiritual ascent.' },
                    'nadi-ida': { title: 'Ida Nadi (Lunar)', content: 'The channel running to the left, associated with cooling, feminine (Yin), mental energy, and the Parasympathetic Nervous System.' },
                    'nadi-pingala': { title: 'Pingala Nadi (Solar)', content: 'The channel running to the right, associated with heating, masculine (Yang), vital energy, and the Sympathetic Nervous System.' },
                    'chakra-muladhara': { title: 'Muladhara (Root)', content: 'Grounding, security, survival. Element: Earth.' },
                    'chakra-svadhisthana': { title: 'Svadhisthana (Sacral)', content: 'Creativity, fluidity, emotion. Element: Water.' },
                    'chakra-manipura': { title: 'Manipura (Solar Plexus)', content: 'Willpower, power, metabolism. Element: Fire.' },
                    'chakra-anahata': { title: 'Anahata (Heart)', content: 'Love, compassion, balance. Element: Air.' },
                    'chakra-vishuddha': { title: 'Vishuddha (Throat)', content: 'Communication, expression, purification. Element: Ether.' },
                    'chakra-ajna': { title: 'Ajna (Third Eye)', content: 'Intuition, wisdom, spiritual sight. Governs Pituitary Gland.' },
                    'chakra-sahasrara': { title: 'Sahasrara (Crown)', content: 'Transcendence, cosmic consciousness. Governs Pineal Gland.' },
                    'vayu-prana': { title: 'Prana Vayu', content: 'Inward and forward moving energy. Governs respiration and reception. Located in the heart/head region.' },
                    'vayu-samana': { title: 'Samana Vayu', content: 'Balancing and equalizing energy. Governs digestion and assimilation. Located in the core/navel region.' },
                    'vayu-apana': { title: 'Apana Vayu', content: 'Downward and outward moving energy. Governs elimination and grounding. Located in the pelvic region.' },
                    'vayu-udana': { title: 'Udana Vayu', content: 'Upward moving energy. Governs speech, exhalation, and ascent to the crown. Located in the throat/head region.' },
                    'vayu-vyana': { title: 'Vyana Vayu', content: 'Pervasive, circulating energy. Governs the distribution of Prana throughout the entire body.' }
                };

                const data = infoData[element.getAttribute('data-info')];
                if (data) {
                    const infoBox = document.getElementById('info-box');
                    document.getElementById('info-title').textContent = data.title;
                    document.getElementById('info-content').textContent = data.content;
                    
                    // Position the info box near the element
                    const rect = element.getBoundingClientRect();
                    const mapRect = mapContainer.getBoundingClientRect();
                    
                    infoBox.style.left = `${rect.left + rect.width / 2 - mapRect.left}px`;
                    infoBox.style.top = `${rect.top + rect.height / 2 - mapRect.top}px`;
                    infoBox.style.display = 'block';
                }
            }

            function hideInfoBox() {
                document.getElementById('info-box').style.display = 'none';
            }

            // --- Flow Management Functions ---
            const allElements = document.querySelectorAll('.chakra, .nadi-line, .vayu-region');

            function clearFlowStates() {
                allElements.forEach(el => {
                    el.classList.remove('active-flow');
                    el.style.removeProperty('--chakra-color');
                    el.style.removeProperty('--nadi-color');
                    el.style.removeProperty('--vayu-color');
                });
            }

            function updateStepDisplay(step) {
                // Highlight the current step in the list
                document.querySelectorAll('.flow-step-item').forEach(el => el.classList.remove('current'));
                const stepEl = document.getElementById(`step-${step}`);
                if (stepEl) {
                    stepEl.classList.add('current');
                    stepEl.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                }
                
                // Update text explanation
                const explanation = flowExplanations[step] || flowExplanations[0];
                explanationTitleEl.textContent = explanation.title;
                explanationTextEl.innerHTML = explanation.text;
            }

            function resetFlow(doScroll) {
                currentFlowStep = 0;
                isAllActive = false;
                clearFlowStates();
                updateStepDisplay(0);

                // Show/hide controls
                nextStepButton.textContent = "Start Flow";
                nextStepButton.classList.remove('bg-green-600', 'hover:bg-green-700');
                nextStepButton.classList.add('bg-indigo-600', 'hover:bg-indigo-700');
                resetButton.style.display = 'none';
                activateAllButton.style.display = 'block';
                
                // Clear active chakras from flow
                document.querySelectorAll('.flow-step-item').forEach((el, index) => {
                    if (index > 0) el.classList.remove('active');
                });

                if (doScroll) {
                    flowStepsList.scrollTop = 0; // Scroll to top on reset
                }
            }
            
            function advanceFlow() {
                if (isAllActive) {
                    resetFlow(true);
                    return;
                }
                
                currentFlowStep++;
                
                if (currentFlowStep > 7) {
                    // Flow is complete (Samadhi State)
                    currentFlowStep = 8; 
                    updateFlowMap(currentFlowStep);
                    activateAllButton.style.display = 'none';
                    resetButton.style.display = 'block';
                    nextStepButton.textContent = "Flow Complete! Reset to Start.";
                    nextStepButton.classList.remove('bg-indigo-600', 'hover:bg-indigo-700');
                    nextStepButton.classList.add('bg-green-600', 'hover:bg-green-700');
                    
                    // Manually update Step 8 appearance
                    const step8El = document.getElementById('step-8');
                    document.querySelectorAll('.flow-step-item').forEach(el => el.classList.remove('current'));
                    if (step8El) {
                        step8El.classList.add('current', 'active');
                        step8El.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                    }
                    
                    return;
                }

                // Normal step advancement
                updateFlowMap(currentFlowStep);
                updateStepDisplay(currentFlowStep);
                
                // Mark previous step as active/done
                const prevStepEl = document.getElementById(`step-${currentFlowStep - 1}`);
                if (prevStepEl) prevStepEl.classList.add('active');
                
                // Update button text
                if (currentFlowStep === 7) {
                    nextStepButton.textContent = "Achieve Samadhi (Final Step)";
                } else {
                    nextStepButton.textContent = `Next Step: Step ${currentFlowStep + 1}`;
                }
            }

            function updateFlowMap(step) {
                clearFlowStates();
                
                // Step 1: Muladhara, Apana Vayu, Sushumna Nadi
                if (step >= 1) {
                    // Nadi: Sushumna (Central Channel)
                    const sushumna = document.getElementById('sushumna-nadi');
                    sushumna.style.setProperty('--nadi-color', nadiColors.sushumna);
                    sushumna.classList.add('active-flow');
                    
                    // Vayu: Vyana (Pervasive energy, always active during flow)
                    const vyana = document.getElementById('vayu-vyana');
                    vyana.style.setProperty('--vayu-color', vayuColors.vyana);
                    vyana.classList.add('active-flow');

                    // Vayu: Apana (Downward energy)
                    const apana = document.getElementById('vayu-apana');
                    apana.style.setProperty('--vayu-color', vayuColors.apana);
                    apana.classList.add('active-flow');
                }

                // Step 2: Svadhisthana
                if (step >= 2) {
                    const svadhisthana = document.getElementById('chakra-svadhisthana');
                    svadhisthana.style.setProperty('--chakra-color', chakraColors.svadhisthana);
                    svadhisthana.classList.add('active-flow');
                }

                // Step 3: Manipura, Samana Vayu
                if (step >= 3) {
                    const manipura = document.getElementById('chakra-manipura');
                    manipura.style.setProperty('--chakra-color', chakraColors.manipura);
                    manipura.classList.add('active-flow');

                    // Vayu: Samana (Navel)
                    const samana = document.getElementById('vayu-samana');
                    samana.style.setProperty('--vayu-color', vayuColors.samana);
                    samana.classList.add('active-flow');
                }

                // Step 4: Anahata, Prana Vayu
                if (step >= 4) {
                    const anahata = document.getElementById('chakra-anahata');
                    anahata.style.setProperty('--chakra-color', chakraColors.anahata);
                    anahata.classList.add('active-flow');

                    // Vayu: Prana (Heart/Chest)
                    const prana = document.getElementById('vayu-prana');
                    prana.style.setProperty('--vayu-color', vayuColors.prana);
                    prana.classList.add('active-flow');
                }

                // Step 5: Vishuddha
                if (step >= 5) {
                    const vishuddha = document.getElementById('chakra-vishuddha');
                    vishuddha.style.setProperty('--chakra-color', chakraColors.vishuddha);
                    vishuddha.classList.add('active-flow');
                }

                // Step 6: Ajna, Ida & Pingala Nadis Balance
                if (step >= 6) {
                    const ajna = document.getElementById('chakra-ajna');
                    ajna.style.setProperty('--chakra-color', chakraColors.ajna);
                    ajna.classList.add('active-flow');
                    
                    // Nadi: Ida and Pingala (Balanced)
                    const ida = document.getElementById('ida-nadi');
                    ida.style.setProperty('--nadi-color', nadiColors.ida);
                    ida.classList.add('active-flow');
                    const pingala = document.getElementById('pingala-nadi');
                    pingala.style.setProperty('--nadi-color', nadiColors.pingala);
                    pingala.classList.add('active-flow');
                }

                // Step 7: Sahasrara, Udana Vayu
                if (step >= 7) {
                    const sahasrara = document.getElementById('chakra-sahasrara');
                    sahasrara.style.setProperty('--chakra-color', chakraColors.sahasrara);
                    sahasrara.classList.add('active-flow');

                    // Vayu: Udana (Upward energy)
                    const udana = document.getElementById('vayu-udana');
                    udana.style.setProperty('--vayu-color', vayuColors.udana);
                    udana.classList.add('active-flow');
                }

                // Loop through steps to activate chakras up to current step
                for (let i = 1; i <= Math.min(step, 7); i++) {
                    const chakraKey = Object.keys(chakraColors)[i - 1];
                    const chakraEl = document.getElementById(`chakra-${chakraKey}`);
                    if (chakraEl) {
                        chakraEl.style.setProperty('--chakra-color', chakraColors[chakraKey]);
                        chakraEl.classList.add('active-flow');
                    }
                }
            }

            // --- Event Listeners and Initialization ---

            // Generate Flow Steps in the list
            for (let i = 1; i <= 7; i++) {
                const stepTitle = flowExplanations[i].title.split(': ')[1]; // Extract just the Chakra name
                const item = document.createElement('div');
                item.id = `step-${i}`;
                item.className = 'flow-step-item p-2 rounded-lg cursor-pointer transition duration-100 border border-gray-200 text-sm hover:bg-indigo-50 hover:border-indigo-400';
                item.textContent = `Step ${i}: ${stepTitle}`;
                item.setAttribute('data-step', i);
                
                item.addEventListener('click', () => {
                    if (currentFlowStep >= i) { // Allow review of completed steps
                        currentFlowStep = i - 1; // Set back one step so advanceFlow works
                        advanceFlow();
                    }
                });
                flowStepsList.appendChild(item);
            }
            
            // Add Samadhi Step
            const samadhiItem = document.createElement('div');
            samadhiItem.id = `step-8`;
            samadhiItem.className = 'flow-step-item p-2 rounded-lg cursor-pointer transition duration-100 border border-gray-200 text-sm hover:bg-orange-50 hover:border-orange-400 font-bold';
            samadhiItem.textContent = flowExplanations[8].title;
            samadhiItem.setAttribute('data-step', 8);
            flowStepsList.appendChild(samadhiItem);


            // General hover listeners for all elements
            allElements.forEach(el => {
                el.addEventListener('mouseenter', () => showInfoBox(el));
                el.addEventListener('mouseleave', hideInfoBox);
            });

            // Button listeners
            nextStepButton.addEventListener('click', advanceFlow);
            resetButton.addEventListener('click', () => resetFlow(true));

            activateAllButton.addEventListener('click', () => {
                isAllActive = !isAllActive;
                if (isAllActive) {
                    currentFlowStep = 8; 
                    clearFlowStates(); 
                    // Manually activate all elements for 'all-active' state
                    allElements.forEach(el => el.classList.add('active-flow'));

                    const step8El = document.getElementById('step-8');
                    document.querySelectorAll('.flow-step-item').forEach(el => el.classList.remove('current'));
                    if (step8El) {
                        step8El.classList.add('current', 'active');
                        step8El.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                    }
                    
                    // Set all Nadi colors to be active, but specifically Sushumna to golden
                    document.getElementById('sushumna-nadi').style.setProperty('--nadi-color', nadiColors.sushumna);
                    document.getElementById('ida-nadi').style.setProperty('--nadi-color', nadiColors.ida);
                    document.getElementById('pingala-nadi').style.setProperty('--nadi-color', nadiColors.pingala);
                    
                    // Set all Chakra colors
                    Object.keys(chakraColors).forEach(key => {
                        const chakraEl = document.getElementById(`chakra-${key}`);
                        if(chakraEl) chakraEl.style.setProperty('--chakra-color', chakraColors[key]);
                    });

                    // Set all Vayu colors
                    Object.keys(vayuColors).forEach(key => {
                        const vayuEl = document.getElementById(`vayu-${key}`);
                        if(vayuEl) vayuEl.style.setProperty('--vayu-color', vayuColors[key]);
                    });

                    resetButton.style.display = 'block'; 
                    activateAllButton.textContent = "Exit Samadhi (Reset)";
                    nextStepButton.style.display = 'none';

                    // Update text explanation to reflect "All Active"
                    explanationTitleEl.textContent = flowExplanations[8].title;
                    explanationTextEl.innerHTML = flowExplanations[8].text;
                    
                    hideInfoBox();
                } else {
                    // If turning off "All Active", go back to the reset state
                    resetFlow(true); // Scroll on reset from all
                    activateAllButton.textContent = "Activate All (Simulate Samadhi)";
                    nextStepButton.style.display = 'block';
                }
            });
            
            // Initialize flow guide state on load
            resetFlow(false); // Initial load, no scroll
        
        }); // End DOMContentLoaded
    </script>
</body>
</html>
